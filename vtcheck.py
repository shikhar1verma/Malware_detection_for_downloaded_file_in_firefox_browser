#!/usr/bin/env python
'''
This will use the AP of virus total request to get the report of the file if it is already present in their database
the id of resource is SHA256.And if the report is not present post the file through seleniumon virustotal for scanning
and get the report in json.
'''
import requests         #importing the libraries
import os
import time
import io , json
from selenium1 import * #importing all functiona from module selenium

def vtCheck(path):                                                              #it will open the file having hash and make a file containning json results
    key = 'd79796ca4e655cef0a89960d1f63a3cfb2f623686d7672f5b6f9bcc1fc5f0f45'    #key given by virus total you can change this key to your key by making your account on virustotal
    input_file=path+'/hash.txt'                                                 #file path of hash.txt

    if input_file and key:                                                      #if key and file path is present
        with open(input_file) as o:                                             #then open the hash file
	    for line in o.readlines():                                          #read the hash
	        md5hash=line.rstrip()
		output_file=md5hash+".json"
		VT_Request(key, md5hash, output_file,path)                      #calling the function vt_request having arguments key hash json result file name and path of of the project
    return path+'/json_result/'+output_file                                     #return the path of output file (json result)

def VT_Request(key, hash, output,path):                                     #it will request for the report of the file if not present then submit the file to virus total and get the result

    params = {'apikey': key, 'resource': hash}                              #putting the the keys and resource(hash) in the form in which API will understand

    url = requests.get('https://www.virustotal.com/vtapi/v2/file/report', params=params)

    json_response = url.json()                                              #converting the dictionary to json format

    response = int(json_response.get('response_code'))                      #checking for the json response

    if response == 0:                                                       #if 0 means that the file is not present in their database
        for root, dirs, files in os.walk(path+'/file-folder', topdown=True):
            for name in files:
                n = os.path.join(root,name)                                 #getting the path of file
        os.chdir(path)
        selenium1(n)                                                        #calling the selenium function which will automatically open the firefox put the required file on virustotal and then we can get the json result
        params = {'apikey': key, 'resource': hash}                          #getting the json result
	response = requests.get('https://www.virustotal.com/vtapi/v2/file/report', params=params)
	json_response = response.json()                                     #converting it to json
        with io.open(path+'/json_result/'+output,'w',encoding = 'utf-8') as fil:
            fil.write(json.dumps(json_response,ensure_ascii=False))         #writing the rsult into the json_result folder


    elif response == 1:                                                     #if response 1 means they have the report of the file
        with io.open(path+'/json_result/'+output,'w',encoding = 'utf-8') as fil:
            fil.write(json.dumps(json_response,ensure_ascii=False))         #we can write this response to the file

    else:
        print hash + ' could not be searched. Please try again later.'      #if no response is given means the virustotal servers are down
#if no response is given means the virustotal servers are down
