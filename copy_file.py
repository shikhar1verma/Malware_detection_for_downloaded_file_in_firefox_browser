#!/usr/bin/env python
'''
This module will go in a infinite loop till any new download happens through firefox and if
new download happen it will check for the filesize of file, if the filesize is less than 4MB
then only it will do the detection for malware.This script will sleep when something is downloaded
for 90 seconds, this can be changes according to the user's internet downloading speed. In those 90
seconds the file should be downloaded else the file will show error.
'''
import os           #importing modules
import sqlite3
import json
import time

def copyFile(fire,data):            #function check for download infinitely for any download
    while True:
        f = []
        d = []
        content = []
        connec = sqlite3.connect(fire)          #connecting to firefox database
        co = sqlite3.connect(data)              #connecting to project's database
        r = connec.cursor()
        s = co.cursor()
        r.execute('SELECT place_id,id  FROM moz_annos ORDER BY id DESC  LIMIT 1;')
        s.execute('SELECT firefox_id,id  FROM logs ORDER BY id DESC  LIMIT 1;')

        for i in r:
            f.append(i[0])
        for k in s:
            d.append(k[0])

        if f[0] != d[0]:                        #checking the condition for download
            time.sleep(90)
            r.execute('SELECT content,id FROM moz_annos ORDER BY id DESC  LIMIT 1;')    #it will extract the contents containning filesize in firefox databse
            for l in r:
                content.append(l[0])
            dic = content[0]
            dic = dic.encode(encoding='utf-8')
            dic = json.loads(dic)
            if int(dic['fileSize'])<=4000000:   #condition of file size for detection of malware(here 4MB)
                break
        s.close()                               #closing all the connection and commiting the result to database
        r.close()
        co.close()
        connec.close()
    s.close()                       #closing all the connection and commiting the result to database
    r.close()
    co.close()
    connec.close()
    return ()                       #will return nothing


